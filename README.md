# Мигратор для БД

Простой мигратор на bash для СУБД MySQL. Реквизиты подключения к БД считываются из конфига `db.conf` - его необходимо поместить рядом с `migrator`.
Предназначен для автономного использования, без зависимостей от платформы / фреймворка. Скрипты миграций пишутся на SQL.

Данный мигратор берет на себя минимальные обязательства, его преимущество в быстром старте и не требовательность к системе:
* нет необходимости создавать отдельную таблицу в БД для контроля актуальной версии миграций,
* окружения (дев / прод) переключаются за счет конфига (пример см. ниже),
* версия текущей миграции сохраняется в текстовом файле.


## Подготовка к работе
* Создайте папку для мираций в директории проекта (например `migrations`),
* убедитесь, что папка `migrations` не доступна по http,
* разместите в эту папку сам `migrator`,
* установите разрешения на исполнение (`a+x`) для `mirgrator`,
* рядом разместите конфиг `db.conf` с реквизитами подключения к БД используемой среды,
* создайте 2 папки `up` и `down` - в них будут размещаться скрипты миграций (`up` - накатить миграцию и `down` - откатить),
* добавьте папки `migrations/up` и `migrations/down` в систему контроля версий, все остальное содержимое папки `migrations` должно быть исключено из под контроля версий.


## Использование
Рекомендуется создавать скрипты миграций атомарными (едиными sql скриптами для каждого коммита). В каждом коммите, в котором требуются изменения в БД, необходимо создать 2 скрипта и разместить в папках `migrations/up` и `migrations/down` - формат названия `0001.sql`.
Для выполнения миграции необходимо выполнить команду:
```
$ migrator [direction] [migration]
```
[direction] - направление миграции (up / down), [migration] - номер миграции (например 0001).
Пример запуска:
```
$ migrator up 0001
```
будет выполнен скрипт миграции `0001.sql` из папки `up`.

Мигратор выполнит (или сделает попытку выполнить) миграцию и запишет статус в файле `last.log`.


## Структура файлов
Если для работы мигратора создать папку `migrations`, то пример рабочей структуры будет выглядеть следующим образом:
```
migrations/
├── up/
│   ├── 0001.sql
│   └── 0002.sql
├── down/
│   ├── 0001.sql
│   └── 0002.sql
├── db.conf
└── last.log
```

## Структура db.conf

Пример конфига для dev среды
```
#!/bin/bash

# Dev env
DB_NAME='db'
DB_USER='user'
DB_PASS='pass'
```
